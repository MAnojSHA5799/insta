// server.js (CommonJS)
const express = require("express");
const bodyParser = require("body-parser");
const cors = require("cors");

const app = express();
const PORT = process.env.PORT || 8000;

app.use(cors());
app.use(bodyParser.json());

// ----------------------
// Valid Tokens
// ----------------------
const validTokens = new Set([
  "token_fb_abc123",
  "token_fb_demo",
  "token_ig_abc123",
  "token_ig_demo"
]);

// ----------------------
// Dummy FB Users (20 users with friends and location)
// ----------------------
const fbBaseId = "122094043977116573"; // string
const fbUsers = [];
const fbUserMap = {};

const fbNames = [
  { firstName: "Manoj", lastName: "Shakya", age: 25, dob: "05/07/1999", user_location: "Kanpur, India" },
  { firstName: "Himanshu", lastName: "Yadav", age: 26, dob: "12/03/1998", user_location: "Noida, India" },
  { firstName: "Jyoti", lastName: "Shakya", age: 24, dob: "11/08/1999", user_location: "Lucknow, India" },
  { firstName: "Anshu", lastName: "Patel", age: 27, dob: "05/06/1997", user_location: "Ahmedabad, India" },
  { firstName: "Mohit", lastName: "Kumar", age: 25, dob: "23/09/1999", user_location: "Bangalore, India" },
  { firstName: "Rohit", lastName: "Verma", age: 28, dob: "15/02/1996", user_location: "Pune, India" },
  { firstName: "Neha", lastName: "Kumar", age: 23, dob: "30/01/2000", user_location: "Chennai, India" },
  { firstName: "Sara", lastName: "Ali", age: 22, dob: "12/12/2001", user_location: "Hyderabad, India" },
  { firstName: "Aman", lastName: "Gupta", age: 29, dob: "09/11/1995", user_location: "Kolkata, India" },
  { firstName: "Pooja", lastName: "Sharma", age: 26, dob: "17/07/1997", user_location: "Mumbai, India" },
  { firstName: "Ravi", lastName: "Patel", age: 28, dob: "05/03/1995", user_location: "Jaipur, India" },
  { firstName: "Ankit", lastName: "Sharma", age: 27, dob: "22/04/1996", user_location: "Lucknow, India" },
  { firstName: "Priya", lastName: "Singh", age: 24, dob: "10/10/1999", user_location: "Delhi, India" },
  { firstName: "Karan", lastName: "Gupta", age: 25, dob: "05/06/1999", user_location: "Noida, India" },
  { firstName: "Simran", lastName: "Kaur", age: 23, dob: "29/08/2000", user_location: "Chandigarh, India" },
  { firstName: "Aakash", lastName: "Verma", age: 27, dob: "11/11/1996", user_location: "Bangalore, India" },
  { firstName: "Neelam", lastName: "Sharma", age: 22, dob: "14/12/2001", user_location: "Hyderabad, India" },
  { firstName: "Suresh", lastName: "Yadav", age: 28, dob: "07/05/1995", user_location: "Gurgaon, India" },
  { firstName: "Anjali", lastName: "Patel", age: 26, dob: "03/03/1997", user_location: "Ahmedabad, India" },
  { firstName: "Mohini", lastName: "Kumar", age: 25, dob: "19/09/1999", user_location: "Pune, India" },

  
];

// ----------------------
// Generate Mock FB Users (with friends + follower count)
// ----------------------
function generateMockUsers() {
  let currentIdNumber = BigInt(fbBaseId);

  fbNames.forEach((user, index) => {
    const userId = (currentIdNumber + BigInt(index)).toString();

    const followers = Math.floor(Math.random() * 5000) + 500; // 500â€“5500
    const friendsCount = Math.floor(Math.random() * 30) + 5; // 5â€“35

    // generate random friends list
    const friends = [];
    while (friends.length < friendsCount) {
      const randomIndex = Math.floor(Math.random() * fbNames.length);
      if (randomIndex !== index && !friends.includes(randomIndex)) {
        friends.push(randomIndex);
      }
    }

    const userData = {
      id: userId,
      name: `${user.firstName} ${user.lastName}`,
      first_name: user.firstName,
      last_name: user.lastName,
      age: user.age,
      dob: user.dob,
      user_location: user.user_location,
      followers: followers,
      friends: friends.map(i => ({
        id: (currentIdNumber + BigInt(i)).toString(),
        name: `${fbNames[i].firstName} ${fbNames[i].lastName}`
      }))
    };

    fbUsers.push(userData);
    fbUserMap[userId] = userData;
  });

  console.log("Mock FB Users Generated:", fbUsers.length);
}

generateMockUsers();



// Add FB users safely using BigInt
fbNames.forEach((user, i) => {
  const id = (BigInt(fbBaseId) + BigInt(i)).toString();
  fbUsers.push({ ...user, id, friends: [] });
  fbUserMap[id] = fbUsers[i];
});

// Assign friends: each user has next 5 users cyclically
const fbIds = Object.keys(fbUserMap);
fbIds.forEach((id, i) => {
  fbUserMap[id].friends = fbIds
    .slice(i + 1, i + 6)
    .map(fid => ({ id: fid, firstName: fbUserMap[fid].firstName, lastName: fbUserMap[fid].lastName }));
});

// ----------------------
// Dummy IG Users (20 users with followers and location)
// ----------------------
const igBaseId = "133094043977116573"; // string
const igUsers = {};
fbNames.forEach((user, i) => {
  const id = (BigInt(igBaseId) + BigInt(i)).toString();
  igUsers[id] = { ...user, id, followers: [] }; // user_location included
});

// Assign followers: each user has next 5 users cyclically
const igIds = Object.keys(igUsers);
igIds.forEach((id, i) => {
  igUsers[id].followers = igIds
    .slice(i + 1, i + 359)
    .map(fid => ({
      id: fid,
      username: igUsers[fid].firstName.toLowerCase() + "_" + igUsers[fid].lastName.toLowerCase()
    }));
});

// ----------------------
// Helper: validate token
// ----------------------
function checkToken(req) {
  const token = req.query.token || req.headers["x-access-token"];
  if (!token) return { ok: false, code: 401, msg: "Token missing" };
  if (!validTokens.has(token)) return { ok: false, code: 403, msg: "Invalid token" };
  return { ok: true, token };
}

// ----------------------
// Health Check
// ----------------------
app.get("/", (req, res) => {
  res.json({ ok: true, message: "Mock Social Server Running..." });
});

// ----------------------
// FACEBOOK API
// ----------------------
app.get("/fb/:id", (req, res) => {
  const { id } = req.params;
  const check = checkToken(req);
  if (!check.ok) return res.status(check.code).json({ error: check.msg });

  const user = fbUserMap[id];
  if (!user) return res.status(404).json({ error: "Facebook user not found" });

  res.json({
    id: user.id,
    firstName: user.firstName,
    lastName: user.lastName,
    age: user.age,
    dob: user.dob || null,
    user_location: user.user_location,
    friends: user.friends,
    totalFriends: user.friends.length
  });
});

// ----------------------
// INSTAGRAM API
// ----------------------
app.get("/ig/:id", (req, res) => {
  const { id } = req.params;
  const check = checkToken(req);
  if (!check.ok) return res.status(check.code).json({ error: check.msg });

  const user = igUsers[id];
  if (!user) return res.status(404).json({ error: "Instagram user not found" });

  res.json({
    id: user.id,
    firstName: user.firstName,
    lastName: user.lastName,
    user_location: user.user_location,
     totalFollowers: user.followers.length,
    // totalFollowers: 358,

    followers: user.followers
  });
});

// ----------------------
// List of Valid Tokens
// ----------------------
app.get("/__tokens", (req, res) => {
  res.json({ validTokens: Array.from(validTokens) });
});

// ----------------------
// Add Token at Runtime
// ----------------------
app.post("/add-token", (req, res) => {
  const body = req.body;
  if (!body || !body.token) return res.status(400).json({ error: "Provide token in body" });
  validTokens.add(body.token.trim());
  res.json({ success: true, tokens: Array.from(validTokens) });
});

// ----------------------
// Start server
// ----------------------
app.listen(PORT, () => {
  console.log(`ðŸš€ Mock Social Server running at http://localhost:${PORT}`);
});
